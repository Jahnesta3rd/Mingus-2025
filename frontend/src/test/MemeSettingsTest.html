<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MemeSettings Component Test</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom animations for testing */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .skeleton {
            background: linear-gradient(90deg, #374151 25%, #4b5563 50%, #374151 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // Mock API functions for testing
        const mockApi = {
            async fetchPreferences(userId) {
                // Simulate API delay
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Return mock preferences
                return {
                    success: true,
                    preferences: {
                        enabled: true,
                        categories: {
                            faith: true,
                            work_life: true,
                            friendships: false,
                            children: true,
                            relationships: true,
                            going_out: false
                        },
                        frequency: 'once_per_day'
                    }
                };
            },
            
            async savePreferences(userId, preferences) {
                // Simulate API delay
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Simulate occasional failures
                if (Math.random() < 0.1) {
                    throw new Error('Network error');
                }
                
                return {
                    success: true,
                    message: 'Preferences saved successfully',
                    preferences
                };
            },
            
            async getPreviewMeme() {
                // Simulate API delay
                await new Promise(resolve => setTimeout(resolve, 800));
                
                return {
                    id: 1,
                    image_url: '/placeholder-meme.jpg',
                    category: 'work_life',
                    caption: 'When you check your bank account on Monday morning ðŸ’¸',
                    alt_text: 'Meme showing shocked face with bank account balance'
                };
            }
        };

        // MemeSettings Component
        const MemeSettings = ({ userId, onPreferencesChange, className = '' }) => {
            const [preferences, setPreferences] = useState({
                enabled: true,
                categories: {
                    faith: true,
                    work_life: true,
                    friendships: true,
                    children: true,
                    relationships: true,
                    going_out: true,
                },
                frequency: 'once_per_day',
            });
            const [loading, setLoading] = useState(true);
            const [saving, setSaving] = useState(false);
            const [error, setError] = useState(null);
            const [success, setSuccess] = useState(null);
            const [previewLoading, setPreviewLoading] = useState(false);
            const [previewMeme, setPreviewMeme] = useState(null);

            const CATEGORY_INFO = {
                faith: { label: 'Faith & Spirituality', description: 'Religious and spiritual financial struggles' },
                work_life: { label: 'Work & Career', description: 'Work-related financial challenges and career expenses' },
                friendships: { label: 'Friendships', description: 'Social spending and friend-related expenses' },
                children: { label: 'Children & Family', description: 'Parenting and child-related financial stress' },
                relationships: { label: 'Relationships', description: 'Dating, marriage, and relationship financial dynamics' },
                going_out: { label: 'Going Out', description: 'Entertainment, dining out, and social activities' },
            };

            const FREQUENCY_OPTIONS = [
                { value: 'every_login', label: 'Every Login', description: 'Show a meme every time you log in' },
                { value: 'once_per_day', label: 'Once Per Day', description: 'Show one meme per day maximum' },
                { value: 'weekly', label: 'Weekly', description: 'Show one meme per week maximum' },
            ];

            const fetchPreferences = useCallback(async () => {
                if (!userId) {
                    setLoading(false);
                    return;
                }

                try {
                    setLoading(true);
                    setError(null);
                    const response = await mockApi.fetchPreferences(userId);
                    setPreferences(response.preferences);
                } catch (err) {
                    setError('Failed to load your meme preferences. Using default settings.');
                } finally {
                    setLoading(false);
                }
            }, [userId]);

            const savePreferences = useCallback(async (newPreferences) => {
                if (!userId) {
                    setError('User ID is required to save preferences');
                    return false;
                }

                try {
                    setSaving(true);
                    setError(null);
                    setSuccess(null);
                    await mockApi.savePreferences(userId, newPreferences);
                    setSuccess('Your meme preferences have been saved successfully!');
                    setPreferences(newPreferences);
                    onPreferencesChange?.(newPreferences);
                    return true;
                } catch (err) {
                    setError('Failed to save your preferences. Please try again.');
                    return false;
                } finally {
                    setSaving(false);
                }
            }, [userId, onPreferencesChange]);

            const previewMemes = useCallback(async () => {
                try {
                    setPreviewLoading(true);
                    setError(null);
                    const meme = await mockApi.getPreviewMeme();
                    setPreviewMeme(meme);
                } catch (err) {
                    setError('Failed to load preview meme. Please try again.');
                } finally {
                    setPreviewLoading(false);
                }
            }, []);

            const resetPreferences = useCallback(async () => {
                const confirmed = window.confirm('Are you sure you want to reset all meme preferences to default settings?');
                if (confirmed) {
                    const defaultPrefs = {
                        enabled: true,
                        categories: {
                            faith: true,
                            work_life: true,
                            friendships: true,
                            children: true,
                            relationships: true,
                            going_out: true,
                        },
                        frequency: 'once_per_day',
                    };
                    await savePreferences(defaultPrefs);
                }
            }, [savePreferences]);

            const handlePreferenceChange = useCallback(async (key, value) => {
                const newPreferences = { ...preferences, [key]: value };
                setPreferences(newPreferences);
                setTimeout(() => {
                    savePreferences(newPreferences);
                }, 500);
            }, [preferences, savePreferences]);

            const handleCategoryToggle = useCallback(async (category) => {
                const newCategories = {
                    ...preferences.categories,
                    [category]: !preferences.categories[category],
                };
                await handlePreferenceChange('categories', newCategories);
            }, [preferences.categories, handlePreferenceChange]);

            useEffect(() => {
                fetchPreferences();
            }, [fetchPreferences]);

            useEffect(() => {
                if (success) {
                    const timer = setTimeout(() => setSuccess(null), 3000);
                    return () => clearTimeout(timer);
                }
            }, [success]);

            if (loading) {
                return (
                    <div className={`bg-white rounded-lg shadow-sm border border-gray-200 p-6 ${className}`}>
                        <div className="animate-pulse">
                            <div className="h-6 bg-gray-200 rounded w-1/3 mb-4"></div>
                            <div className="space-y-3">
                                <div className="h-4 bg-gray-200 rounded w-full"></div>
                                <div className="h-4 bg-gray-200 rounded w-5/6"></div>
                                <div className="h-4 bg-gray-200 rounded w-4/6"></div>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className={`bg-white rounded-lg shadow-sm border border-gray-200 p-6 ${className}`}>
                    <div className="mb-6">
                        <h2 className="text-xl font-semibold text-gray-900 mb-2">
                            Meme Splash Page Settings
                        </h2>
                        <p className="text-gray-600 text-sm">
                            Customize your daily meme experience. Choose which categories you'd like to see
                            and how often memes should appear.
                        </p>
                    </div>

                    {success && (
                        <div className="mb-4 p-3 bg-green-50 border border-green-200 rounded-md">
                            <p className="text-green-800 text-sm">{success}</p>
                        </div>
                    )}
                    
                    {error && (
                        <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded-md">
                            <p className="text-red-800 text-sm">{error}</p>
                        </div>
                    )}

                    <div className="mb-6">
                        <div className="flex items-center justify-between">
                            <div>
                                <h3 className="text-lg font-medium text-gray-900">Enable Daily Memes</h3>
                                <p className="text-gray-600 text-sm">
                                    Turn on or off the meme splash page feature completely
                                </p>
                            </div>
                            <button
                                onClick={() => handlePreferenceChange('enabled', !preferences.enabled)}
                                className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 ${
                                    preferences.enabled ? 'bg-blue-600' : 'bg-gray-200'
                                }`}
                            >
                                <span
                                    className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${
                                        preferences.enabled ? 'translate-x-6' : 'translate-x-1'
                                    }`}
                                />
                            </button>
                        </div>
                    </div>

                    {preferences.enabled && (
                        <div className="space-y-6">
                            <div>
                                <h3 className="text-lg font-medium text-gray-900 mb-3">Meme Categories</h3>
                                <p className="text-gray-600 text-sm mb-4">
                                    Choose which types of memes you'd like to see. You can select multiple categories.
                                </p>
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    {Object.entries(CATEGORY_INFO).map(([category, info]) => (
                                        <label
                                            key={category}
                                            className="flex items-start space-x-3 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition-colors"
                                        >
                                            <input
                                                type="checkbox"
                                                checked={preferences.categories[category]}
                                                onChange={() => handleCategoryToggle(category)}
                                                className="mt-1 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                                            />
                                            <div className="flex-1 min-w-0">
                                                <div className="text-sm font-medium text-gray-900">
                                                    {info.label}
                                                </div>
                                                <div className="text-xs text-gray-500">
                                                    {info.description}
                                                </div>
                                            </div>
                                        </label>
                                    ))}
                                </div>
                            </div>

                            <div>
                                <h3 className="text-lg font-medium text-gray-900 mb-3">Frequency</h3>
                                <p className="text-gray-600 text-sm mb-4">
                                    How often would you like to see memes?
                                </p>
                                
                                <div className="space-y-2">
                                    {FREQUENCY_OPTIONS.map((option) => (
                                        <label
                                            key={option.value}
                                            className="flex items-center space-x-3 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition-colors"
                                        >
                                            <input
                                                type="radio"
                                                name="frequency"
                                                value={option.value}
                                                checked={preferences.frequency === option.value}
                                                onChange={() => handlePreferenceChange('frequency', option.value)}
                                                className="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300"
                                            />
                                            <div className="flex-1 min-w-0">
                                                <div className="text-sm font-medium text-gray-900">
                                                    {option.label}
                                                </div>
                                                <div className="text-xs text-gray-500">
                                                    {option.description}
                                                </div>
                                            </div>
                                        </label>
                                    ))}
                                </div>
                            </div>

                            <div>
                                <h3 className="text-lg font-medium text-gray-900 mb-3">Preview</h3>
                                <p className="text-gray-600 text-sm mb-4">
                                    See what a meme would look like with your current settings.
                                </p>
                                
                                <button
                                    onClick={previewMemes}
                                    disabled={previewLoading || saving}
                                    className="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    {previewLoading ? (
                                        <>
                                            <svg className="animate-spin -ml-1 mr-2 h-4 w-4 text-gray-500" fill="none" viewBox="0 0 24 24">
                                                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                            </svg>
                                            Loading...
                                        </>
                                    ) : (
                                        'Preview Memes'
                                    )}
                                </button>

                                {previewMeme && (
                                    <div className="mt-4 p-4 border border-gray-200 rounded-lg bg-gray-50">
                                        <div className="flex items-start space-x-3">
                                            <div className="flex-shrink-0">
                                                <div className="w-16 h-16 bg-gray-300 rounded-lg flex items-center justify-center">
                                                    <span className="text-gray-500 text-xs">Meme</span>
                                                </div>
                                            </div>
                                            <div className="flex-1 min-w-0">
                                                <div className="text-sm font-medium text-gray-900 capitalize">
                                                    {previewMeme.category?.replace('_', ' ')}
                                                </div>
                                                <div className="text-sm text-gray-600 mt-1">
                                                    {previewMeme.caption}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    <div className="mt-6 pt-6 border-t border-gray-200 flex flex-col sm:flex-row gap-3">
                        <button
                            onClick={resetPreferences}
                            disabled={saving}
                            className="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            Reset to Defaults
                        </button>
                        
                        {saving && (
                            <div className="flex items-center text-sm text-gray-500">
                                <svg className="animate-spin -ml-1 mr-2 h-4 w-4 text-gray-500" fill="none" viewBox="0 0 24 24">
                                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                Saving...
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // Test App Component
        const TestApp = () => {
            const [userId, setUserId] = useState('demo-user-123');
            const [preferences, setPreferences] = useState(null);

            const handlePreferencesChange = (newPreferences) => {
                setPreferences(newPreferences);
                console.log('Preferences updated:', newPreferences);
            };

            return (
                <div className="min-h-screen bg-gray-50 p-8">
                    <div className="max-w-4xl mx-auto">
                        <div className="mb-8">
                            <h1 className="text-3xl font-bold text-gray-900 mb-4">
                                MemeSettings Component Test
                            </h1>
                            <p className="text-gray-600 mb-6">
                                This is a test page for the MemeSettings component. Try changing the settings
                                and see how they work with the mock API.
                            </p>
                        </div>

                        <div className="mb-8 bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                            <h2 className="text-lg font-semibold text-gray-900 mb-4">Test Controls</h2>
                            <div className="space-y-4">
                                <div>
                                    <label htmlFor="userId" className="block text-sm font-medium text-gray-700 mb-2">
                                        User ID (for testing different users)
                                    </label>
                                    <input
                                        id="userId"
                                        type="text"
                                        value={userId}
                                        onChange={(e) => setUserId(e.target.value)}
                                        className="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                        placeholder="Enter user ID"
                                    />
                                </div>
                            </div>
                        </div>

                        {preferences && (
                            <div className="mb-8 bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                                <h2 className="text-lg font-semibold text-gray-900 mb-4">Current Preferences</h2>
                                <div className="bg-gray-50 rounded-md p-4">
                                    <pre className="text-sm text-gray-700 overflow-auto">
                                        {JSON.stringify(preferences, null, 2)}
                                    </pre>
                                </div>
                            </div>
                        )}

                        <MemeSettings
                            userId={userId}
                            onPreferencesChange={handlePreferencesChange}
                        />
                    </div>
                </div>
            );
        };

        // Render the app
        ReactDOM.render(<TestApp />, document.getElementById('root'));
    </script>
</body>
</html>
