<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="touch_target_optimization.css">

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Income Sources</title>
  <link rel="stylesheet" href="static/css/form.css">
</head>
<body>
  <form id="incomeForm">
    <h2>Add New Income</h2>
    <h3>Primary Income</h3>
    <label>
      How much do you receive from your main job?
      <input type="number" name="income_1_amount" required placeholder="$0.00">
    </label>
    <label>
      How often do you receive this income?
      <select name="income_1_frequency" required class="form-input">
        <option value="monthly">Monthly</option>
        <option value="bi-weekly">Bi-weekly</option>
        <option value="weekly">Weekly</option>
        <option value="quarterly">Quarterly</option>
      </select>
    </label>
    <label>
      When do you typically receive this income?
      <input type="date" name="income_1_due_date" required>
    </label>

    <h3>Secondary Income</h3>
    <label>
      Do you have a side gig or second source of income?
      <div class="radio-group">
        <label><input type="radio" name="has_side_gig" value="yes" required> Yes</label>
        <label><input type="radio" name="has_side_gig" value="no" required> No</label>
      </div>
    </label>
    <div id="sideGigFields" class="hidden">
      <label>
        How much do you earn monthly from this side gig?
        <input type="number" name="income_2_amount" placeholder="$0.00">
      </label>
      <label>
        How often do you receive this income?
        <select name="income_2_frequency" class="form-input">
          <option value="monthly">Monthly</option>
          <option value="bi-weekly">Bi-weekly</option>
          <option value="weekly">Weekly</option>
          <option value="quarterly">Quarterly</option>
        </select>
      </label>
      <label>
        When do you typically receive this income?
        <input type="date" name="income_2_due_date">
      </label>
    </div>

    <h3>Child Support</h3>
    <label>
      Do you receive child support?
      <div class="radio-group">
        <label><input type="radio" name="has_child_support" value="yes" required> Yes</label>
        <label><input type="radio" name="has_child_support" value="no" required> No</label>
      </div>
    </label>
    <div id="childSupportFields" class="hidden">
      <label>
        How much do you receive monthly in child support?
        <input type="number" name="child_support_amount" placeholder="$0.00">
      </label>
      <label>
        How often do you receive this income?
        <select name="child_support_frequency" class="form-input">
          <option value="monthly">Monthly</option>
          <option value="bi-weekly">Bi-weekly</option>
          <option value="weekly">Weekly</option>
          <option value="quarterly">Quarterly</option>
        </select>
      </label>
      <label>
        When do you typically receive this income?
        <input type="date" name="child_support_due_date">
      </label>
    </div>
    <div class="button-row">
      <button type="button" onclick="window.history.back()">Back</button>
      <button type="submit">Save</button>
    </div>
  </form>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
  <script>
    // Show/hide conditional fields
    function updateSideGigFields() {
      const val = document.querySelector('input[name="has_side_gig"]:checked');
      document.getElementById('sideGigFields').classList.toggle('hidden', !val || val.value !== 'yes');
    }
    function updateChildSupportFields() {
      const val = document.querySelector('input[name="has_child_support"]:checked');
      document.getElementById('childSupportFields').classList.toggle('hidden', !val || val.value !== 'yes');
    }
    document.querySelectorAll('input[name="has_side_gig"]').forEach(el => {
      el.addEventListener('change', updateSideGigFields);
    });
    document.querySelectorAll('input[name="has_child_support"]').forEach(el => {
      el.addEventListener('change', updateChildSupportFields);
    });

    // Supabase config (replace with your actual values)
    const SUPABASE_URL = 'https://wiemjrvxlqkpbsukdqnbs.supabase.co';
    const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Get user_id if using Supabase Auth (optional)
    async function getUserId() {
      const { data, error } = await supabase.auth.getUser();
      if (error || !data.user) return null;
      return data.user.id;
    }

    document.getElementById('incomeForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const formData = Object.fromEntries(new FormData(this).entries());
      const user_id = await getUserId();
      const rows = [];

      // Main job
      rows.push({
        user_id,
        income_type: 'main',
        amount: formData.income_1_amount,
        frequency: formData.income_1_frequency,
        due_date: formData.income_1_due_date
      });

      // Side gig
      if (formData.has_side_gig === 'yes') {
        rows.push({
          user_id,
          income_type: 'side_gig',
          amount: formData.income_2_amount,
          frequency: formData.income_2_frequency,
          due_date: formData.income_2_due_date
        });
      }

      // Child support
      if (formData.has_child_support === 'yes') {
        rows.push({
          user_id,
          income_type: 'child_support',
          amount: formData.child_support_amount,
          frequency: formData.child_support_frequency,
          due_date: formData.child_support_due_date
        });
      }

      // Insert all rows
      const { error } = await supabase.from('user_income_due_dates').insert(rows);
      if (error) {
        alert('Error saving: ' + error.message);
      } else {
        window.location.href = 'dashboard.html'; // or next step
      }
    });
  </script>
</body>
</html> 