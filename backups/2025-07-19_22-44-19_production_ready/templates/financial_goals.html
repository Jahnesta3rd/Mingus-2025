<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="touch_target_optimization.css">

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Financial Goals</title>
  <link rel="stylesheet" href="/static/css/form.css">
  <style>
    .goal-section { margin-bottom: 2rem; }
    .goal-card { border: 1px solid #e0e0e0; border-radius: 10px; padding: 1.2em; margin-bottom: 1.5em; background: #f8fafc; box-shadow: 0 2px 8px #e0e7ff33; }
    .goal-header { display: flex; align-items: center; justify-content: space-between; }
    .goal-category { font-weight: 600; color: #2563eb; }
    .goal-remove { color: #b91c1c; cursor: pointer; margin-left: 1em; font-size: 1.1em; }
    .goal-fields { display: grid; grid-template-columns: 1fr 1fr; gap: 1em; margin-top: 1em; }
    .goal-fields label { display: flex; flex-direction: column; font-weight: 500; }
    .goal-progress-bar { height: 10px; background: #e0e7ff; border-radius: 5px; margin-top: 0.5em; position: relative; }
    .goal-progress-fill { height: 10px; background: #2563eb; border-radius: 5px; transition: width 0.3s; }
    .priority-stars { display: flex; gap: 0.2em; cursor: pointer; }
    .priority-star { font-size: 1.3em; color: #eab308; }
    .priority-star.inactive { color: #e5e7eb; }
    .goal-feasibility { margin-top: 0.5em; font-size: 0.98em; }
    .goal-feasibility.good { color: #059669; }
    .goal-feasibility.warn { color: #b45309; }
    .goal-feasibility.bad { color: #b91c1c; }
    .timeline-container { margin: 2em 0; }
    .timeline-bar { height: 18px; background: #e0e7ff; border-radius: 9px; position: relative; margin-bottom: 1em; }
    .timeline-goal { position: absolute; top: -8px; height: 34px; border-radius: 8px; background: #2563eb33; border: 2px solid #2563eb; display: flex; align-items: center; padding: 0 0.7em; font-size: 0.98em; font-weight: 600; color: #2563eb; }
    .timeline-goal.conflict { background: #fef3c7; border-color: #f59e42; color: #b45309; }
    .add-goal-btn { background: #2563eb; color: #fff; border: none; border-radius: 6px; padding: 0.6em 1.5em; font-weight: 600; font-size: 1em; margin: 1em 0; transition: background 0.2s; }
    .add-goal-btn:hover { background: #1d4ed8; }
    .btn-mingus-primary { background: #2563eb; color: #fff; border: none; border-radius: 6px; padding: 0.6em 1.5em; font-weight: 600; font-size: 1em; margin-right: 0.5em; transition: background 0.2s; }
    .btn-mingus-primary:disabled { background: #a5b4fc; color: #fff; cursor: not-allowed; }
    .btn-mingus-secondary { background: #f3f4f6; color: #1e293b; border: none; border-radius: 6px; padding: 0.6em 1.5em; font-weight: 600; font-size: 1em; margin-right: 0.5em; }
    .btn-mingus-skip { background: #fffbe6; color: #b45309; border: 1px solid #fde68a; border-radius: 6px; padding: 0.6em 1.5em; font-weight: 600; font-size: 1em; }
    .progress-bar-container { margin-bottom: 1.5em; }
    .progress-bar { display: flex; flex-direction: column; align-items: flex-start; }
    .progress-label { font-size: 1.1em; font-weight: 600; color: #2563eb; margin-bottom: 0.3em; }
    .progress-track { width: 100%; height: 8px; background: #e0e7ff; border-radius: 4px; overflow: hidden; }
    .progress-fill { height: 8px; background: #2563eb; border-radius: 4px; transition: width 0.3s; }
    .saving-indicator { color: #2563eb; font-size: 0.95em; margin-left: 1em; }
    .skip-warning { background: #fffbe6; color: #b45309; border: 1px solid #fde68a; border-radius: 6px; padding: 1em; margin-top: 1em; font-size: 1em; }
    @media (max-width: 700px) {
      .goal-fields { grid-template-columns: 1fr; }
      .timeline-goal { font-size: 0.9em; padding: 0 0.4em; }
    }
  </style>
</head>
<body>
  <form id="financialGoalsForm" autocomplete="off">
    <div class="progress-bar-container">
      <div class="progress-bar" id="progressBar">
        <span class="progress-label">Step 5 of 8</span>
        <div class="progress-track">
          <div class="progress-fill" style="width:62.5%"></div>
        </div>
      </div>
    </div>
    <h2>Set Your Financial Goals</h2>
    <p>Dream big! Set goals that inspire you. We'll help you make them achievable over time.</p>
    <div id="goalsList"></div>
    <button type="button" class="add-goal-btn btn-cta btn-primary" id="addGoalBtn">+ Add Another Goal</button>
    <div class="timeline-container">
      <h3>Goal Timeline</h3>
      <div class="timeline-bar" id="timelineBar"></div>
      <div id="timelineLegend"></div>
    </div>
    <div id="goalWarnings" class="warning"></div>
    <div class="button-row">
      <button type="button" id="prevBtn" class="btn-mingus-secondary btn-cta btn-primary">Previous</button>
      <button type="button" id="skipBtn" class="btn-mingus-skip btn-cta btn-primary">Skip</button>
      <button type="submit" id="nextBtn" class="btn-mingus-primary btn-cta btn-primary" disabled>Next</button>
      <span id="savingIndicator" class="saving-indicator" style="display:none;">Saving...</span>
    </div>
  </form>
  <div id="skipWarning" class="skip-warning" style="display:none;">Are you sure you want to skip? Some features may be unavailable until this step is complete.</div>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
  <script>
    const GOAL_CATEGORIES = [
      { value: 'emergency', label: 'Emergency Fund', tooltip: '3–6 months of expenses for safety net.' },
      { value: 'major_purchase', label: 'Major Purchase', tooltip: 'House, car, or other big item.' },
      { value: 'vacation', label: 'Vacation/Travel', tooltip: 'Dream trip or getaway.' },
      { value: 'debt_payoff', label: 'Debt Payoff', tooltip: 'Pay off loans or credit cards.' },
      { value: 'investment', label: 'Investment/Retirement', tooltip: 'Grow your wealth for the future.' },
      { value: 'custom', label: 'Custom Goal', tooltip: 'Anything else you want to achieve.' }
    ];

    const LOCAL_KEY = 'mingus_financial_goals_autosave';
    let goals = [];
    let autoSaveTimer = null;
    let isSaving = false;
    let offline = false;

    // --- Supabase config (replace with your actual values) ---
    const SUPABASE_URL = 'https://wiemjrvxlqkpbsukdqnbs.supabase.co';
    const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- Helper functions ---
    function formatUSD(val) {
      if (!val) return '';
      return '$' + parseFloat(val).toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2});
    }
    function monthsBetween(start, end) {
      const s = new Date(start), e = new Date(end);
      return Math.max(1, (e.getFullYear() - s.getFullYear()) * 12 + (e.getMonth() - s.getMonth()));
    }
    function todayISO() {
      return new Date().toISOString().slice(0,10);
    }

    // --- UI rendering ---
    function renderGoals() {
      const list = document.getElementById('goalsList');
      list.innerHTML = '';
      goals.forEach((goal, idx) => {
        const card = document.createElement('div');
        card.className = 'goal-card';
        card.innerHTML = `
          <div class="goal-header">
            <span class="goal-category">${GOAL_CATEGORIES.find(c => c.value === goal.goal_category)?.label || 'Custom'}</span>
            <span class="goal-remove" title="Remove goal" data-idx="${idx}">✕</span>
          </div>
          <div class="goal-fields">
            <label>Goal Name
              <input type="text" class="goal-name" value="${goal.goal_name || ''}" data-idx="${idx}" maxlength="40" placeholder="e.g. Emergency Fund" class="form-input">
            </label>
            <label>Category
              <select class="goal-category-select" data-idx="${idx}" class="form-input">
                ${GOAL_CATEGORIES.map(cat => `<option value="${cat.value}" ${goal.goal_category===cat.value?'selected':''}>${cat.label}</option>`).join('')}
              </select>
            </label>
            <label>Target Amount (USD)
              <input type="number" class="goal-amount" value="${goal.target_amount||''}" min="1" step="0.01" data-idx="${idx}" placeholder="$0.00">
            </label>
            <label>Target Date
              <input type="date" class="goal-date" value="${goal.target_date||''}" data-idx="${idx}" min="${todayISO()}">
            </label>
            <label>Current Progress (optional)
              <input type="number" class="goal-progress" value="${goal.current_progress||''}" min="0" step="0.01" data-idx="${idx}" placeholder="$0.00">
            </label>
            <label>Priority
              <span class="priority-stars" data-idx="${idx}">
                ${[1,2,3,4,5].map(star => `<span class="priority-star${goal.priority>=star?'':' inactive'}" data-star="${star}">&#9733;</span>`).join('')}
              </span>
            </label>
          </div>
          <div class="goal-progress-bar"><div class="goal-progress-fill" style="width:${Math.min(100,Math.round(100*(goal.current_progress||0)/(goal.target_amount||1)))}%"></div></div>
          <div class="goal-feasibility" id="feasibility${idx}"></div>
          <div class="goal-monthly" id="monthly${idx}"></div>
        `;
        list.appendChild(card);
      });
      // Add event listeners
      document.querySelectorAll('.goal-remove').forEach(el => {
        el.onclick = e => { goals.splice(+el.dataset.idx,1); renderGoals(); validateGoals(); autoSave(); };
      });
      document.querySelectorAll('.goal-name').forEach(el => {
        el.oninput = e => { goals[+el.dataset.idx].goal_name = el.value; autoSave(); validateGoals(); };
      });
      document.querySelectorAll('.goal-category-select').forEach(el => {
        el.onchange = e => { goals[+el.dataset.idx].goal_category = el.value; autoSave(); renderGoals(); validateGoals(); };
      });
      document.querySelectorAll('.goal-amount').forEach(el => {
        el.oninput = e => { goals[+el.dataset.idx].target_amount = parseFloat(el.value)||''; autoSave(); validateGoals(); };
      });
      document.querySelectorAll('.goal-date').forEach(el => {
        el.oninput = e => { goals[+el.dataset.idx].target_date = el.value; autoSave(); validateGoals(); };
      });
      document.querySelectorAll('.goal-progress').forEach(el => {
        el.oninput = e => { goals[+el.dataset.idx].current_progress = parseFloat(el.value)||0; autoSave(); validateGoals(); };
      });
      document.querySelectorAll('.priority-stars').forEach(el => {
        el.onclick = e => {
          if (e.target.classList.contains('priority-star')) {
            goals[+el.dataset.idx].priority = +e.target.dataset.star;
            renderGoals(); autoSave(); validateGoals();
          }
        };
      });
      // Feasibility and monthly savings
      goals.forEach((goal, idx) => {
        const months = monthsBetween(todayISO(), goal.target_date||todayISO());
        const needed = (goal.target_amount||0) - (goal.current_progress||0);
        const monthly = months>0 ? needed/months : needed;
        const feas = document.getElementById('feasibility'+idx);
        const monthlyDiv = document.getElementById('monthly'+idx);
        if (!goal.target_amount || !goal.target_date) {
          feas.textContent = '';
          monthlyDiv.textContent = '';
          return;
        }
        monthlyDiv.textContent = `You need to save ${formatUSD(monthly)} per month.`;
        // Feasibility check (stub: you can enhance with real income/expense data)
        if (monthly <= 0) {
          feas.textContent = 'Goal already achieved!';
          feas.className = 'goal-feasibility good';
        } else if (monthly < 2000) {
          feas.textContent = 'This goal is realistic!';
          feas.className = 'goal-feasibility good';
        } else if (monthly < 5000) {
          feas.textContent = 'This goal may be challenging.';
          feas.className = 'goal-feasibility warn';
        } else {
          feas.textContent = 'This goal is likely unrealistic. Consider adjusting your timeline or amount.';
          feas.className = 'goal-feasibility bad';
        }
      });
      renderTimeline();
    }

    function renderTimeline() {
      const bar = document.getElementById('timelineBar');
      bar.innerHTML = '';
      if (!goals.length) return;
      // Find min/max dates
      const dates = goals.map(g => g.target_date).filter(Boolean).sort();
      const minDate = dates[0] || todayISO();
      const maxDate = dates[dates.length-1] || todayISO();
      const range = Math.max(1, (new Date(maxDate) - new Date(minDate))/(1000*60*60*24));
      // Place each goal
      goals.forEach((g, idx) => {
        if (!g.target_date) return;
        const left = 100 * ((new Date(g.target_date) - new Date(minDate))/(1000*60*60*24*range));
        const width = 8 + (g.priority||1)*2;
        const div = document.createElement('div');
        div.className = 'timeline-goal';
        div.style.left = `calc(${left}% - ${width/2}px)`;
        div.style.width = width+'em';
        div.textContent = g.goal_name || GOAL_CATEGORIES.find(c=>c.value===g.goal_category)?.label || 'Goal';
        // Conflict detection: highlight if overlapping with another goal in same month
        if (goals.some((other,i)=>i!==idx && other.target_date && other.target_date.slice(0,7)===g.target_date.slice(0,7))) {
          div.classList.add('conflict');
          div.title = 'Potential conflict: overlapping major goals';
        }
        bar.appendChild(div);
      });
    }

    // --- Add/Remove Goal ---
    document.getElementById('addGoalBtn').onclick = function() {
      goals.push({
        goal_name: '',
        goal_category: 'custom',
        target_amount: '',
        target_date: '',
        current_progress: 0,
        priority: 3
      });
      renderGoals(); validateGoals(); autoSave();
    };

    // --- Auto-save logic ---
    function showSavingIndicator(show) {
      document.getElementById('savingIndicator').style.display = show ? '' : 'none';
    }
    function saveToLocal(data) {
      localStorage.setItem(LOCAL_KEY, JSON.stringify(data));
    }
    function loadFromLocal() {
      const data = localStorage.getItem(LOCAL_KEY);
      return data ? JSON.parse(data) : null;
    }
    function autoSave() {
      if (isSaving) return;
      isSaving = true;
      showSavingIndicator(true);
      saveToLocal(goals);
      if (navigator.onLine) {
        fetch('/api/financial-goals', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({goals})
        }).then(() => {
          isSaving = false;
          showSavingIndicator(false);
        }).catch(() => {
          isSaving = false;
          showSavingIndicator(false);
        });
      } else {
        offline = true;
        isSaving = false;
        showSavingIndicator(false);
      }
    }
    function scheduleAutoSave() {
      if (autoSaveTimer) clearInterval(autoSaveTimer);
      autoSaveTimer = setInterval(autoSave, 30000);
    }

    // --- Restore on load ---
    window.addEventListener('DOMContentLoaded', async () => {
      // Try to load from backend first
      try {
        const resp = await fetch('/api/financial-goals');
        const data = await resp.json();
        if (data.goals && data.goals.length) {
          goals = data.goals;
        } else {
          const saved = loadFromLocal();
          if (saved) goals = saved;
          else goals = [];
        }
      } catch {
        const saved = loadFromLocal();
        if (saved) goals = saved;
        else goals = [];
      }
      if (!goals.length) {
        // Suggest Emergency Fund as first goal
        goals.push({
          goal_name: 'Emergency Fund',
          goal_category: 'emergency',
          target_amount: '',
          target_date: '',
          current_progress: 0,
          priority: 4
        });
      }
      renderGoals();
      scheduleAutoSave();
      validateGoals();
    });

    document.getElementById('financialGoalsForm').addEventListener('focusout', autoSave, true);
    document.getElementById('financialGoalsForm').addEventListener('submit', autoSave);
    window.addEventListener('online', () => { offline = false; autoSave(); });
    window.addEventListener('offline', () => { offline = true; });

    // --- Validation ---
    function validateGoals() {
      let valid = true;
      let errors = [];
      let warnings = [];
      goals.forEach((g, idx) => {
        if (!g.goal_name || !g.goal_category || !g.target_amount || !g.target_date) {
          valid = false;
        }
        if (g.target_amount && g.target_amount < 1) {
          errors.push(`Goal "${g.goal_name||'Goal'}" amount must be at least $1.`);
          valid = false;
        }
        if (g.target_date && new Date(g.target_date) < new Date(todayISO())) {
          errors.push(`Goal "${g.goal_name||'Goal'}" date must be in the future.`);
          valid = false;
        }
      });
      // Conflict warning
      const months = goals.map(g=>g.target_date?g.target_date.slice(0,7):null).filter(Boolean);
      const hasConflict = months.some((m,i)=>months.indexOf(m)!==i);
      if (hasConflict) warnings.push('Some goals overlap in the same month. Consider adjusting timelines.');
      // Display errors/warnings
      const warnDiv = document.getElementById('goalWarnings');
      warnDiv.innerHTML = '';
      if (errors.length) warnDiv.innerHTML += '<div style="color:#b91c1c;font-weight:bold;">'+errors.join('<br>')+'</div>';
      if (warnings.length) warnDiv.innerHTML += '<div style="color:#b45309;font-weight:bold;">'+warnings.join('<br>')+'</div>';
      document.getElementById('nextBtn').disabled = !valid;
      return valid;
    }
    document.getElementById('financialGoalsForm').addEventListener('input', validateGoals);
    document.getElementById('financialGoalsForm').addEventListener('change', validateGoals);

    document.getElementById('financialGoalsForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      if (!validateGoals()) return;
      try {
        await fetch('/api/financial-goals', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({goals})
        });
        localStorage.removeItem(LOCAL_KEY);
        window.location.href = '/onboarding/next-step';
      } catch (err) {
        alert('There was an error saving your goals. Please try again.');
      }
    });

    document.getElementById('prevBtn').onclick = function() {
      window.location.href = '/onboarding/expense-profile';
    };
    document.getElementById('nextBtn').onclick = function(e) {
      if (!validateGoals()) { e.preventDefault(); return; }
      document.getElementById('financialGoalsForm').submit();
    };
    document.getElementById('skipBtn').onclick = function() {
      document.getElementById('skipWarning').style.display = '';
      setTimeout(() => { document.getElementById('skipWarning').style.display = 'none'; }, 5000);
    };
  </script>
</body>
</html> 