{% extends "base.html" %}

{% block title %}Edit Meme - Mingus Meme Admin{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0">
                <i class="bi bi-pencil me-2"></i>
                Edit Meme
            </h1>
            <a href="{{ url_for('list_memes') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i>
                Back to List
            </a>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-pencil-square me-2"></i>
                    Edit Meme Information
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data" id="memeForm">
                    <!-- Current Image Display -->
                    <div class="mb-4">
                        <label class="form-label">
                            <i class="bi bi-image me-1"></i>
                            Current Image
                        </label>
                        <div class="border rounded p-3 text-center bg-light">
                            <img src="{{ url_for('uploaded_file', filename=meme.image_url) }}" 
                                 alt="{{ meme.alt_text }}" 
                                 class="img-fluid" 
                                 style="max-height: 300px; max-width: 100%;"
                                 onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDMwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0xMDAgMTAwSDEwMFYxMDBIMTAwWiIgc3Ryb2tlPSIjQ0NDIiBzdHJva2Utd2lkdGg9IjIiIGZpbGw9Im5vbmUiLz4KPHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDMwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0xMDAgMTAwSDEwMFYxMDBIMTAwWiIgc3Ryb2tlPSIjQ0NDIiBzdHJva2Utd2lkdGg9IjIiIGZpbGw9Im5vbmUiLz4KPC9zdmc+Cg=='">
                        </div>
                        <div class="form-text">
                            <i class="bi bi-info-circle me-1"></i>
                            Current image. Upload a new image below to replace it.
                        </div>
                    </div>

                    <!-- New Image Upload -->
                    <div class="mb-4">
                        <label for="image" class="form-label">
                            <i class="bi bi-upload me-1"></i>
                            Replace Image (Optional)
                        </label>
                        <input type="file" 
                               class="form-control" 
                               id="image" 
                               name="image" 
                               accept="image/*"
                               onchange="previewNewImage(this)">
                        <div class="form-text">
                            <i class="bi bi-info-circle me-1"></i>
                            Leave empty to keep current image. Supported formats: PNG, JPG, JPEG, GIF, WEBP. Maximum size: 5MB.
                        </div>
                        
                        <!-- New Image Preview -->
                        <div class="mt-3" id="new-preview-container" style="display: none;">
                            <label class="form-label">New Image Preview:</label>
                            <div class="border rounded p-3 text-center">
                                <img id="new-image-preview" 
                                     class="img-fluid" 
                                     style="max-height: 300px; max-width: 100%;"
                                     alt="New image preview">
                            </div>
                        </div>
                    </div>

                    <!-- Category Selection -->
                    <div class="mb-4">
                        <label for="category" class="form-label">
                            <i class="bi bi-tags me-1"></i>
                            Category <span class="text-danger">*</span>
                        </label>
                        <select class="form-select" id="category" name="category" required>
                            <option value="">Select a category...</option>
                            {% for category in categories %}
                            <option value="{{ category }}" {% if category == meme.category %}selected{% endif %}>
                                {{ category.replace('_', ' ').title() }}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">
                            <i class="bi bi-info-circle me-1"></i>
                            Choose the appropriate category for this meme.
                        </div>
                    </div>

                    <!-- Caption -->
                    <div class="mb-4">
                        <label for="caption" class="form-label">
                            <i class="bi bi-chat-text me-1"></i>
                            Caption <span class="text-danger">*</span>
                        </label>
                        <textarea class="form-control" 
                                  id="caption" 
                                  name="caption" 
                                  rows="3" 
                                  placeholder="Enter the meme caption..."
                                  required
                                  maxlength="500">{{ meme.caption }}</textarea>
                        <div class="form-text">
                            <i class="bi bi-info-circle me-1"></i>
                            The main text that appears with the meme. Maximum 500 characters.
                        </div>
                        <div class="text-end">
                            <small class="text-muted">
                                <span id="caption-count">{{ meme.caption|length }}</span>/500 characters
                            </small>
                        </div>
                    </div>

                    <!-- Alt Text -->
                    <div class="mb-4">
                        <label for="alt_text" class="form-label">
                            <i class="bi bi-eye me-1"></i>
                            Alt Text <span class="text-danger">*</span>
                        </label>
                        <textarea class="form-control" 
                                  id="alt_text" 
                                  name="alt_text" 
                                  rows="2" 
                                  placeholder="Describe the image for accessibility..."
                                  required
                                  maxlength="200">{{ meme.alt_text }}</textarea>
                        <div class="form-text">
                            <i class="bi bi-info-circle me-1"></i>
                            Description of the image for screen readers and accessibility. Maximum 200 characters.
                        </div>
                        <div class="text-end">
                            <small class="text-muted">
                                <span id="alt-text-count">{{ meme.alt_text|length }}</span>/200 characters
                            </small>
                        </div>
                    </div>

                    <!-- Active Status -->
                    <div class="mb-4">
                        <div class="form-check">
                            <input class="form-check-input" 
                                   type="checkbox" 
                                   id="is_active" 
                                   name="is_active" 
                                   {% if meme.is_active %}checked{% endif %}>
                            <label class="form-check-label" for="is_active">
                                <i class="bi bi-check-circle me-1"></i>
                                Active (meme will be shown to users)
                            </label>
                        </div>
                        <div class="form-text">
                            <i class="bi bi-info-circle me-1"></i>
                            Uncheck to temporarily hide this meme from users.
                        </div>
                    </div>

                    <!-- Meme Info -->
                    <div class="mb-4">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="bi bi-info-circle me-1"></i>
                                    Meme Information
                                </h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <small class="text-muted">Created:</small><br>
                                        <span class="fw-bold">{{ meme.created_at[:19] }}</span>
                                    </div>
                                    <div class="col-md-6">
                                        <small class="text-muted">Last Updated:</small><br>
                                        <span class="fw-bold">{{ meme.updated_at[:19] }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Submit Buttons -->
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle me-1"></i>
                            Update Meme
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                            <i class="bi bi-arrow-clockwise me-1"></i>
                            Reset Changes
                        </button>
                        <a href="{{ url_for('list_memes') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-x-circle me-1"></i>
                            Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Help Panel -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-question-circle me-2"></i>
                    Edit Guidelines
                </h5>
            </div>
            <div class="card-body">
                <h6 class="text-primary">
                    <i class="bi bi-lightbulb me-1"></i>
                    Editing Tips
                </h6>
                <ul class="list-unstyled small">
                    <li>• You can replace the image by uploading a new one</li>
                    <li>• Leave the image field empty to keep the current image</li>
                    <li>• All text fields are required</li>
                    <li>• Changes are saved immediately when you submit</li>
                    <li>• The old image will be automatically deleted if replaced</li>
                </ul>

                <h6 class="text-primary mt-3">
                    <i class="bi bi-shield-check me-1"></i>
                    Best Practices
                </h6>
                <ul class="list-unstyled small">
                    <li>• Keep captions relatable and humorous</li>
                    <li>• Write descriptive alt text for accessibility</li>
                    <li>• Test changes before making memes active</li>
                    <li>• Use high-quality replacement images</li>
                    <li>• Consider the impact of changes on user experience</li>
                </ul>

                <h6 class="text-primary mt-3">
                    <i class="bi bi-exclamation-triangle me-1"></i>
                    Important Notes
                </h6>
                <ul class="list-unstyled small">
                    <li>• All fields are required</li>
                    <li>• Maximum file size: 5MB</li>
                    <li>• New images are automatically optimized</li>
                    <li>• Changes affect all users immediately</li>
                </ul>
            </div>
        </div>

        <!-- Current Status -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-info-circle me-2"></i>
                    Current Status
                </h5>
            </div>
            <div class="card-body">
                <div class="d-flex align-items-center mb-2">
                    <span class="me-2">Status:</span>
                    {% if meme.is_active %}
                        <span class="badge bg-success">
                            <i class="bi bi-check-circle me-1"></i>
                            Active
                        </span>
                    {% else %}
                        <span class="badge bg-secondary">
                            <i class="bi bi-pause-circle me-1"></i>
                            Inactive
                        </span>
                    {% endif %}
                </div>
                <div class="d-flex align-items-center mb-2">
                    <span class="me-2">Category:</span>
                    <span class="badge bg-primary">
                        {{ meme.category.replace('_', ' ').title() }}
                    </span>
                </div>
                <div class="d-flex align-items-center">
                    <span class="me-2">ID:</span>
                    <code>{{ meme.id }}</code>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Character counters
document.getElementById('caption').addEventListener('input', function() {
    const count = this.value.length;
    document.getElementById('caption-count').textContent = count;
    
    if (count > 450) {
        document.getElementById('caption-count').className = 'text-warning';
    } else if (count > 480) {
        document.getElementById('caption-count').className = 'text-danger';
    } else {
        document.getElementById('caption-count').className = 'text-muted';
    }
});

document.getElementById('alt_text').addEventListener('input', function() {
    const count = this.value.length;
    document.getElementById('alt-text-count').textContent = count;
    
    if (count > 180) {
        document.getElementById('alt-text-count').className = 'text-warning';
    } else if (count > 190) {
        document.getElementById('alt-text-count').className = 'text-danger';
    } else {
        document.getElementById('alt-text-count').className = 'text-muted';
    }
});

// Form validation
document.getElementById('memeForm').addEventListener('submit', function(e) {
    const fileInput = document.getElementById('image');
    const file = fileInput.files[0];
    
    if (file) {
        // Check file size (5MB = 5 * 1024 * 1024 bytes)
        if (file.size > 5 * 1024 * 1024) {
            e.preventDefault();
            alert('File size must be less than 5MB');
            return false;
        }
        
        // Check file type
        const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif', 'image/webp'];
        if (!allowedTypes.includes(file.type)) {
            e.preventDefault();
            alert('Please select a valid image file (PNG, JPG, JPEG, GIF, or WEBP)');
            return false;
        }
    }
});

// Reset form function
function resetForm() {
    // Reset to original values
    document.getElementById('category').value = '{{ meme.category }}';
    document.getElementById('caption').value = '{{ meme.caption }}';
    document.getElementById('alt_text').value = '{{ meme.alt_text }}';
    document.getElementById('is_active').checked = {{ 'true' if meme.is_active else 'false' }};
    document.getElementById('image').value = '';
    document.getElementById('new-preview-container').style.display = 'none';
    
    // Update character counts
    document.getElementById('caption-count').textContent = '{{ meme.caption|length }}';
    document.getElementById('alt-text-count').textContent = '{{ meme.alt_text|length }}';
    document.getElementById('caption-count').className = 'text-muted';
    document.getElementById('alt-text-count').className = 'text-muted';
}

// Enhanced new image preview
function previewNewImage(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        
        // Check file size
        if (file.size > 5 * 1024 * 1024) {
            alert('File size must be less than 5MB');
            input.value = '';
            return;
        }
        
        // Check file type
        const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif', 'image/webp'];
        if (!allowedTypes.includes(file.type)) {
            alert('Please select a valid image file (PNG, JPG, JPEG, GIF, or WEBP)');
            input.value = '';
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById('new-image-preview');
            const container = document.getElementById('new-preview-container');
            
            preview.src = e.target.result;
            container.style.display = 'block';
        };
        reader.readAsDataURL(file);
    } else {
        document.getElementById('new-preview-container').style.display = 'none';
    }
}
</script>
{% endblock %}
