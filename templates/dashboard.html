{% extends "base.html" %}

{% block title %}Dashboard - Secure Financial Portal{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Welcome, {{ current_user.username }}!</h2>
        <span class="security-badge {{ current_user.security_level }}">
            {{ current_user.security_level.title() }} Security
        </span>
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
        <!-- Security Status -->
        <div class="card">
            <h3 style="margin-bottom: 1rem; color: var(--primary-color);">Security Status</h3>
            <div style="margin-bottom: 0.5rem;">
                <strong>Last Login:</strong> 
                {{ current_user.last_login.strftime('%Y-%m-%d %H:%M:%S') if current_user.last_login else 'Never' }}
            </div>
            <div style="margin-bottom: 0.5rem;">
                <strong>Account Created:</strong> 
                {{ current_user.created_at.strftime('%Y-%m-%d') }}
            </div>
            <div style="margin-bottom: 0.5rem;">
                <strong>Account Status:</strong> 
                <span style="color: {{ 'var(--success-color)' if current_user.is_active else 'var(--danger-color)' }}">
                    {{ 'Active' if current_user.is_active else 'Inactive' }}
                </span>
            </div>
            <div style="margin-bottom: 0.5rem;">
                <strong>Verification:</strong> 
                <span style="color: {{ 'var(--success-color)' if current_user.is_verified else 'var(--warning-color)' }}">
                    {{ 'Verified' if current_user.is_verified else 'Pending' }}
                </span>
            </div>
        </div>

        <!-- Active Sessions -->
        <div class="card">
            <h3 style="margin-bottom: 1rem; color: var(--primary-color);">Active Sessions</h3>
            <div style="margin-bottom: 1rem;">
                <strong>Current Sessions:</strong> {{ sessions|length }}
            </div>
            {% if sessions %}
            <div style="max-height: 200px; overflow-y: auto;">
                {% for session in sessions[:3] %}
                <div style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px; margin-bottom: 0.5rem;">
                    <div style="display: flex; align-items: center; margin-bottom: 0.25rem;">
                        <span class="session-status {{ 'current' if session.session_id == session.get('session_id') else 'active' }}"></span>
                        <strong>{{ session.device_info }}</strong>
                    </div>
                    <div style="font-size: 0.9rem; color: #666;">
                        {{ session.ip_address }} â€¢ {{ session.location or 'Unknown Location' }}
                    </div>
                    <div style="font-size: 0.8rem; color: #999;">
                        Last activity: {{ session.last_activity.strftime('%H:%M:%S') }}
                    </div>
                </div>
                {% endfor %}
                {% if sessions|length > 3 %}
                <div style="text-align: center; color: var(--primary-color); font-size: 0.9rem;">
                    +{{ sessions|length - 3 }} more sessions
                </div>
                {% endif %}
            </div>
            {% else %}
            <p style="color: #666; font-style: italic;">No active sessions</p>
            {% endif %}
        </div>
    </div>

    <!-- Quick Actions -->
    <div style="margin-top: 1.5rem;">
        <h3 style="margin-bottom: 1rem; color: var(--primary-color);">Quick Actions</h3>
        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
            <a href="{{ url_for('view_sessions') }}" class="btn btn-primary">View All Sessions</a>
            <a href="{{ url_for('security_settings') }}" class="btn btn-warning">Security Settings</a>
            <a href="{{ url_for('logout_all_devices') }}" class="btn btn-danger" 
               onclick="return confirm('Are you sure you want to log out from all devices?')">
                Logout All Devices
            </a>
        </div>
    </div>
</div>

<!-- Security Alerts -->
<div class="card">
    <h3 style="margin-bottom: 1rem; color: var(--primary-color);">Security Alerts</h3>
    <div id="securityAlerts">
        <!-- Alerts will be populated by JavaScript -->
    </div>
</div>

<script>
// Fetch and display security alerts
async function loadSecurityAlerts() {
    try {
        const response = await fetch('/api/sessions');
        const sessions = await response.json();
        
        const alertsContainer = document.getElementById('securityAlerts');
        let alerts = [];
        
        // Check for multiple sessions from different locations
        const locations = [...new Set(sessions.map(s => s.location).filter(l => l))];
        if (locations.length > 1) {
            alerts.push({
                type: 'warning',
                message: `Multiple active sessions detected from ${locations.length} different locations.`
            });
        }
        
        // Check for sessions older than 1 hour
        const oldSessions = sessions.filter(s => {
            const lastActivity = new Date(s.last_activity);
            const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000);
            return lastActivity < oneHourAgo;
        });
        
        if (oldSessions.length > 0) {
            alerts.push({
                type: 'warning',
                message: `${oldSessions.length} session(s) have been inactive for over 1 hour.`
            });
        }
        
        // Display alerts
        if (alerts.length === 0) {
            alertsContainer.innerHTML = '<p style="color: var(--success-color);">No security alerts at this time.</p>';
        } else {
            alertsContainer.innerHTML = alerts.map(alert => 
                `<div class="alert alert-${alert.type}">${alert.message}</div>`
            ).join('');
        }
    } catch (error) {
        console.error('Failed to load security alerts:', error);
    }
}

// Load alerts on page load
loadSecurityAlerts();

// Refresh alerts every 30 seconds
setInterval(loadSecurityAlerts, 30000);
</script>
{% endblock %}
