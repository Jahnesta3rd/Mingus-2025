<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="touch_target_optimization.css">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Set Your Financial Goals - Mingus</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1rem;
        }
        .form-content {
            padding: 40px;
        }
        .goal-setting-form {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .progress-container {
            margin-bottom: 2rem;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }
        .progress-text {
            text-align: center;
            margin-top: 0.5rem;
            color: #6b7280;
            font-size: 0.9rem;
        }
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
            position: relative;
        }
        .step-indicator::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            height: 2px;
            background: #e5e7eb;
            z-index: 1;
        }
        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
        }
        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #e5e7eb;
            color: #6b7280;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }
        .step.active .step-number {
            background: #667eea;
            color: white;
        }
        .step.completed .step-number {
            background: #10b981;
            color: white;
        }
        .step-label {
            font-size: 0.8rem;
            color: #6b7280;
            text-align: center;
            font-weight: 500;
        }
        .step.active .step-label {
            color: #667eea;
            font-weight: 600;
        }
        .step.completed .step-label {
            color: #10b981;
            font-weight: 600;
        }
        .form-step {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        .form-step.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .form-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border-radius: 8px;
            background: #f8fafc;
            border-left: 4px solid #667eea;
        }
        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .section-icon {
            font-size: 1.2rem;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
            font-size: 1rem;
        }
        .form-label .required-indicator {
            color: #dc2626;
            margin-left: 0.25rem;
        }
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            font-family: inherit;
        }
        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .form-input.error, .form-select.error, .form-textarea.error {
            border-color: #dc2626;
        }
        .form-input.error:focus, .form-select.error:focus, .form-textarea.error:focus {
            border-color: #dc2626;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }
        .error-message {
            display: none;
            color: #dc2626;
            font-size: 0.875rem;
            margin-top: 0.5rem;
            padding: 0.5rem;
            background-color: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 0.375rem;
        }
        .error-message.show {
            display: block;
        }
        .form-help-text {
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 0.25rem;
            margin-bottom: 0.5rem;
        }
        .validation-feedback {
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: #2563eb;
        }
        .goal-preview {
            background: #f0f4ff;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        .goal-preview h3 {
            color: #1f2937;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }
        .goal-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        .goal-detail {
            background: white;
            padding: 1rem;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }
        .goal-detail .label {
            font-size: 0.8rem;
            color: #6b7280;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        .goal-detail .value {
            font-size: 1rem;
            color: #1f2937;
            font-weight: 500;
        }
        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
        }
        .nav-btn {
            padding: 0.75rem 1.5rem;
            border: 2px solid #667eea;
            border-radius: 0.5rem;
            background: white;
            color: #667eea;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 1rem;
        }
        .nav-btn:hover:not(:disabled) {
            background: #667eea;
            color: white;
        }
        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .nav-btn.primary {
            background: #667eea;
            color: white;
        }
        .nav-btn.primary:hover:not(:disabled) {
            background: #5a67d8;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        .success-message {
            display: none;
            background: #ecfdf5;
            border: 1px solid #a7f3d0;
            color: #065f46;
            padding: 2rem;
            border-radius: 0.5rem;
            text-align: center;
            margin-bottom: 2rem;
        }
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        .fieldset {
            border: none;
            padding: 0;
            margin: 0;
        }
        .legend {
            font-size: 1.3rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
        }
        .checkbox-item:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        .checkbox-item.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }
        .checkbox-item input[type="checkbox"] {
            margin: 0;
            width: 1.25rem;
            height: 1.25rem;
            accent-color: #667eea;
        }
        .checkbox-item label {
            cursor: pointer;
            font-weight: 500;
            color: #374151;
            flex: 1;
        }
        /* Focus indicators for keyboard navigation */
        .form-input:focus-visible,
        .form-select:focus-visible,
        .form-textarea:focus-visible,
        .nav-btn:focus-visible,
        .checkbox-item:focus-visible {
            outline: 2px solid #667eea;
            outline-offset: 2px;
        }
        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .form-input, .form-select, .form-textarea {
                border-width: 3px;
            }
            .nav-btn {
                border-width: 3px;
            }
        }
        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            .form-step {
                animation: none;
            }
            .nav-btn.primary:hover:not(:disabled) {
                transform: none;
            }
        }
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            .step-indicator {
                flex-direction: column;
                gap: 1rem;
            }
            .step-indicator::before {
                display: none;
            }
            .navigation-buttons {
                flex-direction: column;
                gap: 1rem;
            }
            .form-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎯 Set Your Financial Goals</h1>
            <p>Create personalized financial goals and track your progress towards financial wellness</p>
        </div>
        
        <div class="form-content">
            <!-- Success message -->
            <div class="success-message" id="successMessage" role="alert" aria-live="polite">
                <strong>✅ Financial goals created successfully!</strong><br>
                Your goals have been saved and you can now track your progress in the dashboard.
            </div>
            
            <form class="goal-setting-form" id="goalSettingForm" novalidate aria-label="Financial Goal Setting Form">
                <!-- Progress indicator -->
                <div class="progress-container" role="progressbar" aria-label="Goal creation progress" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">Step 1 of 4</div>
                </div>
                
                <!-- Step indicator -->
                <div class="step-indicator">
                    <div class="step active" data-step="1">
                        <div class="step-number">1</div>
                        <div class="step-label">Goal Type</div>
                    </div>
                    <div class="step" data-step="2">
                        <div class="step-number">2</div>
                        <div class="step-label">Details</div>
                    </div>
                    <div class="step" data-step="3">
                        <div class="step-number">3</div>
                        <div class="step-label">Timeline</div>
                    </div>
                    <div class="step" data-step="4">
                        <div class="step-number">4</div>
                        <div class="step-label">Review</div>
                    </div>
                </div>
                
                <!-- Step 1: Goal Type Selection -->
                <div class="form-step active" id="step1" data-step="1">
                    <fieldset class="fieldset">
                        <legend class="legend">
                            <div class="section-icon" aria-hidden="true">🎯</div>
                            What type of financial goal do you want to set?
                        </legend>
                        
                        <div class="form-help-text">Select the category that best describes your financial goal</div>
                        
                        <div class="checkbox-group" role="group" aria-labelledby="goal-type-group">
                            <div class="checkbox-item" id="emergency-fund">
                                <input type="radio" name="goal_type" value="emergency_fund" id="emergency_fund" required aria-describedby="emergencyFundDesc">
                                <label for="emergency_fund">Emergency Fund</label>
                                <div class="sr-only" id="emergencyFundDesc">Build a safety net for unexpected expenses</div>
                            </div>
                            <div class="checkbox-item" id="debt-payoff">
                                <input type="radio" name="goal_type" value="debt_payoff" id="debt_payoff" required aria-describedby="debtPayoffDesc">
                                <label for="debt_payoff">Debt Payoff</label>
                                <div class="sr-only" id="debtPayoffDesc">Eliminate high-interest debt</div>
                            </div>
                            <div class="checkbox-item" id="savings">
                                <input type="radio" name="goal_type" value="savings" id="savings" required aria-describedby="savingsDesc">
                                <label for="savings">Savings Goal</label>
                                <div class="sr-only" id="savingsDesc">Save for a specific purchase or event</div>
                            </div>
                            <div class="checkbox-item" id="investment">
                                <input type="radio" name="goal_type" value="investment" id="investment" required aria-describedby="investmentDesc">
                                <label for="investment">Investment Goal</label>
                                <div class="sr-only" id="investmentDesc">Build wealth through investments</div>
                            </div>
                            <div class="checkbox-item" id="retirement">
                                <input type="radio" name="goal_type" value="retirement" id="retirement" required aria-describedby="retirementDesc">
                                <label for="retirement">Retirement Planning</label>
                                <div class="sr-only" id="retirementDesc">Secure your financial future</div>
                            </div>
                            <div class="checkbox-item" id="home-purchase">
                                <input type="radio" name="goal_type" value="home_purchase" id="home_purchase" required aria-describedby="homePurchaseDesc">
                                <label for="home_purchase">Home Purchase</label>
                                <div class="sr-only" id="homePurchaseDesc">Save for a down payment on a home</div>
                            </div>
                        </div>
                        
                        <div class="error-message" id="goalTypeError" role="alert" aria-live="polite"></div>
                    </fieldset>
                </div>
                
                <!-- Step 2: Goal Details -->
                <div class="form-step" id="step2" data-step="2">
                    <fieldset class="fieldset">
                        <legend class="legend">
                            <div class="section-icon" aria-hidden="true">📝</div>
                            Goal Details
                        </legend>
                        
                        <div class="form-section">
                            <div class="section-title">
                                <div class="section-icon" aria-hidden="true">✏️</div>
                                Basic Information
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="goal_name">
                                    Goal Name
                                    <span class="required-indicator" aria-label="required">*</span>
                                </label>
                                <div class="form-help-text">Give your goal a memorable name</div>
                                <input 
                                    type="text" 
                                    id="goal_name" 
                                    name="goal_name"
                                    class="form-input"
                                    placeholder="e.g., Emergency Fund, Vacation Savings"
                                    required
                                    aria-describedby="goalNameHelp goalNameError"
                                    aria-invalid="false"
                                 class="form-input">
                                <div class="validation-feedback" id="goalNameHelp">Choose a name that motivates you</div>
                                <div class="error-message" id="goalNameError" role="alert" aria-live="polite"></div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label" for="target_amount">
                                        Target Amount
                                        <span class="required-indicator" aria-label="required">*</span>
                                    </label>
                                    <div class="form-help-text">How much do you want to save or pay off?</div>
                                    <input 
                                        type="number" 
                                        id="target_amount" 
                                        name="target_amount"
                                        class="form-input"
                                        min="0" 
                                        step="100"
                                        placeholder="e.g., 10000"
                                        required
                                        aria-describedby="targetAmountHelp targetAmountError"
                                        aria-invalid="false"
                                    >
                                    <div class="validation-feedback" id="targetAmountHelp">Enter the total amount you want to achieve</div>
                                    <div class="error-message" id="targetAmountError" role="alert" aria-live="polite"></div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label" for="current_amount">
                                        Current Amount
                                    </label>
                                    <div class="form-help-text">How much have you already saved or paid?</div>
                                    <input 
                                        type="number" 
                                        id="current_amount" 
                                        name="current_amount"
                                        class="form-input"
                                        min="0" 
                                        step="100"
                                        placeholder="e.g., 2000"
                                        aria-describedby="currentAmountHelp"
                                    >
                                    <div class="validation-feedback" id="currentAmountHelp">Leave as 0 if starting from scratch</div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="goal_description">
                                    Goal Description
                                </label>
                                <div class="form-help-text">Why is this goal important to you?</div>
                                <textarea 
                                    id="goal_description" 
                                    name="goal_description"
                                    class="form-textarea"
                                    placeholder="Describe why this goal matters and what it will help you achieve..."
                                    rows="4"
                                    aria-describedby="goalDescriptionHelp"
                                 class="form-input"></textarea>
                                <div class="validation-feedback" id="goalDescriptionHelp">This helps keep you motivated</div>
                            </div>
                        </div>
                    </fieldset>
                </div>
                
                <!-- Step 3: Timeline and Strategy -->
                <div class="form-step" id="step3" data-step="3">
                    <fieldset class="fieldset">
                        <legend class="legend">
                            <div class="section-icon" aria-hidden="true">📅</div>
                            Timeline and Strategy
                        </legend>
                        
                        <div class="form-section">
                            <div class="section-title">
                                <div class="section-icon" aria-hidden="true">⏰</div>
                                When do you want to achieve this goal?
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label" for="target_date">
                                        Target Date
                                        <span class="required-indicator" aria-label="required">*</span>
                                    </label>
                                    <div class="form-help-text">When do you want to reach your goal?</div>
                                    <input 
                                        type="date" 
                                        id="target_date" 
                                        name="target_date"
                                        class="form-input"
                                        required
                                        aria-describedby="targetDateHelp targetDateError"
                                        aria-invalid="false"
                                    >
                                    <div class="validation-feedback" id="targetDateHelp">Choose a realistic but motivating deadline</div>
                                    <div class="error-message" id="targetDateError" role="alert" aria-live="polite"></div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label" for="priority_level">
                                        Priority Level
                                        <span class="required-indicator" aria-label="required">*</span>
                                    </label>
                                    <div class="form-help-text">How important is this goal to you?</div>
                                    <select 
                                        id="priority_level" 
                                        name="priority_level"
                                        class="form-select"
                                        required
                                        aria-describedby="priorityLevelHelp priorityLevelError"
                                        aria-invalid="false"
                                     class="form-input">
                                        <option value="">Select priority</option>
                                        <option value="1">1 - Highest Priority</option>
                                        <option value="2">2 - High Priority</option>
                                        <option value="3">3 - Medium Priority</option>
                                        <option value="4">4 - Low Priority</option>
                                        <option value="5">5 - Lowest Priority</option>
                                    </select>
                                    <div class="validation-feedback" id="priorityLevelHelp">Higher priority goals get more attention</div>
                                    <div class="error-message" id="priorityLevelError" role="alert" aria-live="polite"></div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="monthly_contribution">
                                    Monthly Contribution
                                </label>
                                <div class="form-help-text">How much can you contribute each month?</div>
                                <input 
                                    type="number" 
                                    id="monthly_contribution" 
                                    name="monthly_contribution"
                                    class="form-input"
                                    min="0" 
                                    step="50"
                                    placeholder="e.g., 500"
                                    aria-describedby="monthlyContributionHelp"
                                >
                                <div class="validation-feedback" id="monthlyContributionHelp">This helps calculate your timeline</div>
                            </div>
                        </div>
                    </fieldset>
                </div>
                
                <!-- Step 4: Review and Confirm -->
                <div class="form-step" id="step4" data-step="4">
                    <fieldset class="fieldset">
                        <legend class="legend">
                            <div class="section-icon" aria-hidden="true">✅</div>
                            Review Your Goal
                        </legend>
                        
                        <div class="goal-preview" id="goalPreview">
                            <h3>Goal Summary</h3>
                            <div class="goal-details" id="goalDetails">
                                <!-- Goal details will be populated here -->
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <div class="section-title">
                                <div class="section-icon" aria-hidden="true">🔔</div>
                                Notification Preferences
                            </div>
                            
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="email_notifications" name="email_notifications" value="true" checked>
                                    <label for="email_notifications">Email notifications</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="sms_notifications" name="sms_notifications" value="true">
                                    <label for="sms_notifications">SMS notifications</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="progress_reminders" name="progress_reminders" value="true" checked>
                                    <label for="progress_reminders">Weekly progress reminders</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="milestone_celebrations" name="milestone_celebrations" value="true" checked>
                                    <label for="milestone_celebrations">Milestone celebrations</label>
                                </div>
                            </div>
                        </div>
                    </fieldset>
                </div>
                
                <!-- Navigation Buttons -->
                <div class="navigation-buttons">
                    <button type="button" class="nav-btn btn-cta btn-primary" id="prevBtn" onclick="previousStep()" disabled>
                        ← Previous
                    </button>
                    <button type="button" class="nav-btn primary btn-cta btn-primary" id="nextBtn" onclick="nextStep()">
                        Next →
                    </button>
                    <button type="submit" class="nav-btn primary btn-cta btn-primary" id="submitBtn" style="display: none;">
                        Create Goal
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        class GoalSettingForm {
            constructor() {
                this.currentStep = 1;
                this.totalSteps = 4;
                this.form = document.getElementById('goalSettingForm');
                this.progressFill = document.getElementById('progressFill');
                this.progressText = document.getElementById('progressText');
                this.prevBtn = document.getElementById('prevBtn');
                this.nextBtn = document.getElementById('nextBtn');
                this.submitBtn = document.getElementById('submitBtn');
                this.successMessage = document.getElementById('successMessage');
                
                this.initializeEventListeners();
                this.updateProgress();
                this.announceToScreenReader('Financial goal setting form loaded. Step 1 of 4: Choose your goal type.');
            }

            initializeEventListeners() {
                // Form submission
                this.form.addEventListener('submit', (e) => this.handleSubmit(e));

                // Goal type selection
                const goalTypeInputs = this.form.querySelectorAll('input[name="goal_type"]');
                goalTypeInputs.forEach(input => {
                    input.addEventListener('change', () => this.handleGoalTypeChange());
                });

                // Real-time validation
                const formFields = this.form.querySelectorAll('input[required], select[required]');
                formFields.forEach(field => {
                    field.addEventListener('blur', () => this.validateField(field));
                    field.addEventListener('input', () => this.clearFieldError(field));
                });
            }

            handleGoalTypeChange() {
                const selectedGoalType = this.form.querySelector('input[name="goal_type"]:checked');
                if (selectedGoalType) {
                    // Update checkbox styling
                    document.querySelectorAll('.checkbox-item').forEach(item => {
                        item.classList.remove('selected');
                    });
                    selectedGoalType.closest('.checkbox-item').classList.add('selected');
                    
                    this.announceToScreenReader(`${selectedGoalType.value.replace('_', ' ')} goal type selected`);
                }
            }

            nextStep() {
                if (this.currentStep < this.totalSteps) {
                    if (this.validateCurrentStep()) {
                        this.currentStep++;
                        this.updateStepDisplay();
                        this.updateProgress();
                        this.announceToScreenReader(`Step ${this.currentStep} of ${this.totalSteps}`);
                    } else {
                        this.announceToScreenReader('Please complete all required fields before proceeding.');
                        return;
                    }
                }
            }

            previousStep() {
                if (this.currentStep > 1) {
                    this.currentStep--;
                    this.updateStepDisplay();
                    this.updateProgress();
                    this.announceToScreenReader(`Step ${this.currentStep} of ${this.totalSteps}`);
                }
            }

            updateStepDisplay() {
                // Hide all steps
                document.querySelectorAll('.form-step').forEach(step => {
                    step.classList.remove('active');
                });
                
                // Show current step
                const currentStepElement = document.getElementById(`step${this.currentStep}`);
                if (currentStepElement) {
                    currentStepElement.classList.add('active');
                }
                
                // Update step indicators
                document.querySelectorAll('.step').forEach((step, index) => {
                    const stepNumber = index + 1;
                    step.classList.remove('active', 'completed');
                    
                    if (stepNumber === this.currentStep) {
                        step.classList.add('active');
                    } else if (stepNumber < this.currentStep) {
                        step.classList.add('completed');
                    }
                });
                
                // Update navigation buttons
                this.prevBtn.disabled = this.currentStep === 1;
                
                if (this.currentStep === this.totalSteps) {
                    this.nextBtn.style.display = 'none';
                    this.submitBtn.style.display = 'inline-block';
                    this.populateGoalPreview();
                } else {
                    this.nextBtn.style.display = 'inline-block';
                    this.submitBtn.style.display = 'none';
                }
            }

            updateProgress() {
                const progress = (this.currentStep / this.totalSteps) * 100;
                this.progressFill.style.width = `${progress}%`;
                this.progressText.textContent = `Step ${this.currentStep} of ${this.totalSteps}`;
                
                // Update ARIA progress bar
                const progressBar = document.querySelector('[role="progressbar"]');
                progressBar.setAttribute('aria-valuenow', Math.round(progress));
                progressBar.setAttribute('aria-valuetext', `Step ${this.currentStep} of ${this.totalSteps}`);
            }

            validateCurrentStep() {
                const currentStepElement = document.getElementById(`step${this.currentStep}`);
                const requiredFields = currentStepElement.querySelectorAll('[required]');
                let isValid = true;
                
                requiredFields.forEach(field => {
                    if (!this.validateField(field)) {
                        isValid = false;
                    }
                });
                
                return isValid;
            }

            validateField(field) {
                const errorElement = document.getElementById(field.id + 'Error');
                let isValid = true;
                let errorMessage = '';

                // Remove existing error styling
                field.classList.remove('error');
                field.setAttribute('aria-invalid', 'false');
                if (errorElement) {
                    errorElement.style.display = 'none';
                    errorElement.classList.remove('show');
                }

                // Validation rules
                if (field.hasAttribute('required') && field.value.trim() === '') {
                    isValid = false;
                    errorMessage = 'This field is required';
                } else if (field.type === 'number') {
                    const value = parseFloat(field.value);
                    if (field.value && value < 0) {
                        isValid = false;
                        errorMessage = 'Please enter a positive number';
                    }
                } else if (field.type === 'date') {
                    const selectedDate = new Date(field.value);
                    const today = new Date();
                    if (field.value && selectedDate <= today) {
                        isValid = false;
                        errorMessage = 'Please select a future date';
                    }
                }

                // Apply error styling and message
                if (!isValid) {
                    field.classList.add('error');
                    field.setAttribute('aria-invalid', 'true');
                    if (errorElement) {
                        errorElement.textContent = errorMessage;
                        errorElement.style.display = 'block';
                        errorElement.classList.add('show');
                    }
                    
                    this.announceToScreenReader(`Error: ${errorMessage}`);
                }

                return isValid;
            }

            clearFieldError(field) {
                if (field.classList.contains('error')) {
                    field.classList.remove('error');
                    field.setAttribute('aria-invalid', 'false');
                    const errorElement = document.getElementById(field.id + 'Error');
                    if (errorElement) {
                        errorElement.style.display = 'none';
                        errorElement.classList.remove('show');
                    }
                }
            }

            populateGoalPreview() {
                const goalDetails = document.getElementById('goalDetails');
                const formData = new FormData(this.form);
                const data = Object.fromEntries(formData.entries());
                
                const goalTypeLabels = {
                    'emergency_fund': 'Emergency Fund',
                    'debt_payoff': 'Debt Payoff',
                    'savings': 'Savings Goal',
                    'investment': 'Investment Goal',
                    'retirement': 'Retirement Planning',
                    'home_purchase': 'Home Purchase'
                };
                
                const priorityLabels = {
                    '1': 'Highest Priority',
                    '2': 'High Priority',
                    '3': 'Medium Priority',
                    '4': 'Low Priority',
                    '5': 'Lowest Priority'
                };
                
                goalDetails.innerHTML = `
                    <div class="goal-detail">
                        <div class="label">Goal Type</div>
                        <div class="value">${goalTypeLabels[data.goal_type] || 'Not selected'}</div>
                    </div>
                    <div class="goal-detail">
                        <div class="label">Goal Name</div>
                        <div class="value">${data.goal_name || 'Not specified'}</div>
                    </div>
                    <div class="goal-detail">
                        <div class="label">Target Amount</div>
                        <div class="value">$${(data.target_amount || 0).toLocaleString()}</div>
                    </div>
                    <div class="goal-detail">
                        <div class="label">Current Amount</div>
                        <div class="value">$${(data.current_amount || 0).toLocaleString()}</div>
                    </div>
                    <div class="goal-detail">
                        <div class="label">Target Date</div>
                        <div class="value">${data.target_date || 'Not set'}</div>
                    </div>
                    <div class="goal-detail">
                        <div class="label">Priority Level</div>
                        <div class="value">${priorityLabels[data.priority_level] || 'Not set'}</div>
                    </div>
                    <div class="goal-detail">
                        <div class="label">Monthly Contribution</div>
                        <div class="value">$${(data.monthly_contribution || 0).toLocaleString()}</div>
                    </div>
                `;
                
                this.announceToScreenReader('Goal preview populated. Review your goal details before submitting.');
            }

            async handleSubmit(event) {
                event.preventDefault();

                if (!this.validateCurrentStep()) {
                    this.announceToScreenReader('Form has validation errors. Please correct them before submitting.');
                    return;
                }

                // Show loading state
                this.submitBtn.disabled = true;
                this.submitBtn.textContent = 'Creating Goal...';
                this.announceToScreenReader('Creating your financial goal, please wait...');

                try {
                    const formData = new FormData(this.form);
                    const data = Object.fromEntries(formData.entries());

                    // Convert string values to appropriate types
                    data.target_amount = parseFloat(data.target_amount) || 0;
                    data.current_amount = parseFloat(data.current_amount) || 0;
                    data.monthly_contribution = parseFloat(data.monthly_contribution) || 0;
                    data.priority_level = parseInt(data.priority_level);

                    const response = await fetch('/api/financial/goals/create', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });

                    if (response.ok) {
                        this.showSuccess();
                        this.announceToScreenReader('Financial goal created successfully!');
                    } else {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Failed to create goal');
                    }
                } catch (error) {
                    console.error('Goal creation error:', error);
                    this.announceToScreenReader(`Error creating goal: ${error.message}`);
                    alert('Failed to create financial goal. Please try again.');
                } finally {
                    this.submitBtn.disabled = false;
                    this.submitBtn.textContent = 'Create Goal';
                }
            }

            showSuccess() {
                this.successMessage.style.display = 'block';
                this.form.style.display = 'none';
            }

            announceToScreenReader(message) {
                // Create a live region for screen reader announcements
                let liveRegion = document.getElementById('screen-reader-announcements');
                if (!liveRegion) {
                    liveRegion = document.createElement('div');
                    liveRegion.id = 'screen-reader-announcements';
                    liveRegion.setAttribute('aria-live', 'polite');
                    liveRegion.setAttribute('aria-atomic', 'true');
                    liveRegion.className = 'sr-only';
                    document.body.appendChild(liveRegion);
                }
                
                liveRegion.textContent = message;
                
                // Clear the message after a short delay
                setTimeout(() => {
                    liveRegion.textContent = '';
                }, 1000);
            }
        }

        // Global functions for navigation buttons
        function nextStep() {
            goalForm.nextStep();
        }

        function previousStep() {
            goalForm.previousStep();
        }

        // Initialize the form when DOM is loaded
        let goalForm;
        document.addEventListener('DOMContentLoaded', () => {
            goalForm = new GoalSettingForm();
        });
    </script>
</body>
</html>
