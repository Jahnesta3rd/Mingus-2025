<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Expense Items</title>
  <link rel="stylesheet" href="static/css/form.css">
  <style>
    .btn {
      @apply px-3 py-1 rounded font-semibold transition-colors;
    }
    .btn-primary {
      @apply bg-blue-600 text-white hover:bg-blue-700;
    }
    .btn-secondary {
      @apply bg-gray-200 text-gray-800 hover:bg-gray-300;
    }
  </style>
</head>
<body>
  <form id="expenseForm">
    <h2>Now let's look at your expenses</h2>
    <div id="expense-fields">
      <!-- Expense fields will be injected here by JS -->
    </div>
    <div class="button-row">
      <button type="button" onclick="window.history.back()">Back</button>
      <button type="submit">Save</button>
    </div>
    <label for="starting-balance">Starting Cash Balance</label>
    <input type="number" id="starting-balance" name="starting-balance" min="0" step="0.01" required placeholder="e.g. 1500.00" />
  </form>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
  <script>
    // Expense categories and their field names
    const expenseCategories = [
      { name: 'utilities_expense', label: 'Utilities' },
      { name: 'grocery_expense', label: 'Groceries' },
      { name: 'subscriptions_expense', label: 'Subscriptions' },
      { name: 'entertainment_expense', label: 'Entertainment' },
      { name: 'selfcare_expense', label: 'Self Care' },
      { name: 'gift_others_expense', label: 'Gifts/Charity' },
      { name: 'healthcare_expense', label: 'Healthcare' },
      { name: 'career_expense', label: 'Career/Professional' },
      { name: 'pet_expense', label: 'Pet Expenses' },
      { name: 'child_support_expense', label: 'Child Support (Paid)' },
      { name: 'auto_gas_expense', label: 'Auto Gas' },
      { name: 'auto_insurance_expense', label: 'Auto Insurance' },
      { name: 'health_insurance_expense', label: 'Health Insurance' },
      { name: 'restaurant_meals_expense', label: 'Restaurant Meals' },
      { name: 'bus_fare_expense', label: 'Bus Fare' },
      { name: 'fraternity_sorority_expense', label: 'Fraternity/Sorority' },
      { name: 'credit_card1_expense', label: 'Credit Card 1 Amount' },
      { name: 'credit_card1_name', label: 'Credit Card 1 Name', type: 'text' },
      { name: 'credit_card2_expense', label: 'Credit Card 2 Amount' },
      { name: 'credit_card2_name', label: 'Credit Card 2 Name', type: 'text' },
      { name: 'credit_card3_expense', label: 'Credit Card 3 Amount' },
      { name: 'credit_card3_name', label: 'Credit Card 3 Name', type: 'text' },
      { name: 'rideshare_expense', label: 'Rideshare (Uber/Lyft)' },
      { name: 'loan_1_name', label: 'Loan 1 Name', type: 'text' },
      { name: 'loan_1_expense', label: 'Loan 1 Amount' },
      { name: 'loan_2_name', label: 'Loan 2 Name', type: 'text' },
      { name: 'loan_2_expense', label: 'Loan 2 Amount' },
      { name: 'loan_3_name', label: 'Loan 3 Name', type: 'text' },
      { name: 'loan_3_expense', label: 'Loan 3 Amount' },
      { name: 'rent_or_mortgage_expense', label: 'Rent or Mortgage' },
      { name: 'mobile_phone_expense', label: 'Mobile Phone' },
      { name: 'daycare_expense', label: 'Daycare' },
      { name: 'cash_to_family_expense', label: 'Cash to Family' },
      { name: 'auto_payment_expense', label: 'Auto Payment' },
      { name: 'personal_care_expense', label: 'Personal Care' }
    ];

    // Render fields
    const expenseFieldsDiv = document.getElementById('expense-fields');
    expenseCategories.forEach(cat => {
      const type = cat.type || 'number';
      const label = document.createElement('label');
      label.innerHTML = `${cat.label} <input type="${type}" name="${cat.name}" placeholder="${type === 'number' ? '$0.00' : 'Enter name'}">`;
      expenseFieldsDiv.appendChild(label);
      if (type === 'number') {
        // Frequency
        const freqLabel = document.createElement('label');
        freqLabel.innerHTML = `Frequency
          <select name="${cat.name}_frequency">
            <option value="monthly">Monthly</option>
            <option value="bi-weekly">Bi-weekly</option>
            <option value="weekly">Weekly</option>
            <option value="quarterly">Quarterly</option>
          </select>`;
        expenseFieldsDiv.appendChild(freqLabel);
        // Due date
        const dueLabel = document.createElement('label');
        dueLabel.innerHTML = `Due Date <input type="date" name="${cat.name}_due_date">`;
        expenseFieldsDiv.appendChild(dueLabel);
      }
    });

    // Supabase config (replace with your actual values)
    const SUPABASE_URL = 'https://wiemjrvxlqkpbsukdqnbs.supabase.co';
    const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Get user_id if using Supabase Auth
    async function getUserId() {
      const { data, error } = await supabase.auth.getUser();
      if (error || !data.user) return null;
      return data.user.id;
    }

    document.getElementById('expenseForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const formData = Object.fromEntries(new FormData(this).entries());
      const user_id = await getUserId();
      if (!user_id) {
        alert('You must be signed in.');
        return;
      }
      const row = { user_id };
      expenseCategories.forEach(cat => {
        row[cat.name] = formData[cat.name] || null;
        if (!cat.type || cat.type === 'number') {
          row[`${cat.name}_frequency`] = formData[`${cat.name}_frequency`] || null;
          row[`${cat.name}_due_date`] = formData[`${cat.name}_due_date`] || null;
        }
      });
      row.created_at = new Date().toISOString();
      row.updated_at = new Date().toISOString();
      // Insert into Supabase
      try {
        const { error } = await supabase.from('user_expense_items').insert([row]);
        if (error) {
          showError(error.message || "Failed to save expense.");
          return;
        }
        showSuccess("Expense saved!");
      } catch (err) {
        showError("Network error. Please try again.");
      }
    });

    function showError(message) {
      alert(message);
    }

    function showSuccess(message) {
      alert(message);
    }

    const handleLogout = async () => {
      await supabase.auth.signOut();
      navigate("/login");
    };

    const handleSave = async (formData) => {
      const user = useStore.getState().user;
      if (!user) return;
      const { error } = await supabase
        .from("important_dates")
        .upsert({ ...formData, user_id: user.id });
      // Optionally refetch or update state
    };
  </script>
</body>
</html> 