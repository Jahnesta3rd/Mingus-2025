# üöÄ MINGUS Application - Nginx Deployment Guide

## üîç **403 Error Troubleshooting & Resolution**

This guide addresses the common 403 errors in your Flask application deployed with Nginx and provides comprehensive solutions.

## üìã **Quick Diagnosis Checklist**

Before diving deep, run these quick checks:

```bash
# 1. Check container status
docker ps -a | grep mingus

# 2. Check Nginx logs
docker logs mingus_nginx_prod

# 3. Check web container logs
docker logs mingus_web_prod

# 4. Test connectivity
curl -I http://localhost:5002/health
curl -I https://localhost/health
```

## üö® **Common 403 Error Causes & Solutions**

### **1. Port Configuration Mismatch**

**Problem**: Your configurations have conflicting port settings:
- `nginx.conf`: `mingus-app:5002`
- `nginx-ssl.conf`: `127.0.0.1:5001`
- Flask app: `5001`
- Docker service: `5002`

**Solution**: Use the unified configuration:

```bash
# Replace the old config with the optimized one
cp nginx-optimized.conf nginx.conf
```

### **2. Missing Nginx Dockerfile**

**Problem**: Docker Compose references a non-existent Dockerfile.

**Solution**: The Dockerfile has been created with proper security settings.

### **3. SSL Certificate Issues**

**Problem**: SSL certificates may not exist or have wrong permissions.

**Solution**: 
```bash
# Create SSL directory
mkdir -p deployment/nginx/ssl

# Generate self-signed certificates for development
openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
    -keyout deployment/nginx/ssl/private.key \
    -out deployment/nginx/ssl/certificate.crt \
    -subj "/C=US/ST=State/L=City/O=Organization/CN=localhost"

# Set proper permissions
chmod 600 deployment/nginx/ssl/private.key
chmod 644 deployment/nginx/ssl/certificate.crt
```

## üõ†Ô∏è **Step-by-Step Deployment**

### **Step 1: Update Configuration Files**

1. **Replace Nginx configuration**:
   ```bash
   cd deployment/nginx
   cp nginx-optimized.conf nginx.conf
   ```

2. **Verify configuration syntax**:
   ```bash
   docker run --rm -v $(pwd):/etc/nginx nginx:alpine nginx -t
   ```

### **Step 2: Prepare SSL Certificates**

1. **For Development** (self-signed):
   ```bash
   # Use the certificates generated by the Dockerfile
   # They're automatically created during build
   ```

2. **For Production** (Let's Encrypt or commercial):
   ```bash
   # Place your certificates in deployment/nginx/ssl/
   # - certificate.crt (or fullchain.pem)
   # - private.key
   # - ca_bundle.crt (if needed)
   ```

### **Step 3: Deploy with Docker Compose**

1. **Stop existing services**:
   ```bash
   docker-compose -f deployment/docker-compose.production.yml down
   ```

2. **Rebuild and start**:
   ```bash
   docker-compose -f deployment/docker-compose.production.yml up --build -d
   ```

3. **Verify deployment**:
   ```bash
   docker-compose -f deployment/docker-compose.production.yml ps
   ```

### **Step 4: Test Configuration**

1. **Health check**:
   ```bash
   curl -k https://localhost/health
   # Should return: healthy
   ```

2. **API endpoint test**:
   ```bash
   curl -k https://localhost/api/health
   # Should return Flask app response
   ```

3. **Security headers test**:
   ```bash
   curl -k -I https://localhost/
   # Should show security headers
   ```

## üîß **Advanced Troubleshooting**

### **Run Comprehensive Diagnostics**

Use the troubleshooting script to identify issues:

```bash
cd deployment/nginx
python3 troubleshoot_403.py
```

### **Manual Container Debugging**

1. **Access Nginx container**:
   ```bash
   docker exec -it mingus_nginx_prod sh
   ```

2. **Check Nginx status**:
   ```bash
   nginx -t
   nginx -s reload
   ```

3. **Check logs**:
   ```bash
   tail -f /var/log/nginx/error.log
   tail -f /var/log/nginx/access.log
   ```

### **Network Connectivity Testing**

1. **Test container-to-container communication**:
   ```bash
   docker exec mingus_nginx_prod ping web
   docker exec mingus_nginx_prod curl http://web:5002/health
   ```

2. **Check Docker network**:
   ```bash
   docker network ls
   docker network inspect mingus_mingus_network
   ```

## üîí **Security Configuration**

### **Security Headers Verification**

Your configuration includes comprehensive security headers:

- **HSTS**: `max-age=31536000; includeSubDomains; preload`
- **CSP**: Content Security Policy with Stripe integration
- **X-Frame-Options**: `DENY`
- **X-Content-Type-Options**: `nosniff`
- **X-XSS-Protection**: `1; mode=block`

### **Rate Limiting Configuration**

- **API endpoints**: 10 requests/second
- **Login endpoints**: 5 requests/second
- **Static files**: 20 requests/second
- **General requests**: 30 requests/second

## üìä **Monitoring & Logging**

### **Access Logs**

```bash
# View real-time access logs
docker exec mingus_nginx_prod tail -f /var/log/nginx/access.log

# Filter for specific status codes
docker exec mingus_nginx_prod grep " 403 " /var/log/nginx/access.log
```

### **Error Logs**

```bash
# View real-time error logs
docker exec mingus_nginx_prod tail -f /var/log/nginx/error.log

# Check for specific errors
docker exec mingus_nginx_prod grep -i "error\|403\|forbidden" /var/log/nginx/error.log
```

### **Performance Monitoring**

```bash
# Check Nginx status
docker exec mingus_nginx_prod nginx -s status

# Monitor resource usage
docker stats mingus_nginx_prod
```

## üöÄ **Performance Optimization**

### **Gzip Compression**

Already configured for:
- Text files (CSS, JS, HTML)
- JSON and XML
- SVG images

### **Caching Strategy**

- **Static files**: 1 year cache
- **HTML files**: 1 hour cache
- **API responses**: No cache (dynamic content)

### **Connection Pooling**

- **Keep-alive**: 32 connections
- **Keep-alive timeout**: 60 seconds
- **Keep-alive requests**: 100 per connection

## üîÑ **Maintenance & Updates**

### **Regular Health Checks**

1. **Daily monitoring**:
   ```bash
   curl -k https://your-domain.com/health
   ```

2. **SSL certificate monitoring**:
   ```bash
   docker exec mingus_nginx_prod openssl x509 -in /etc/nginx/ssl/certificate.crt -noout -dates
   ```

### **Configuration Updates**

1. **Test configuration**:
   ```bash
   docker exec mingus_nginx_prod nginx -t
   ```

2. **Reload configuration**:
   ```bash
   docker exec mingus_nginx_prod nginx -s reload
   ```

3. **Restart container** (if needed):
   ```bash
   docker restart mingus_nginx_prod
   ```

## üìù **Troubleshooting Common Issues**

### **Issue: 502 Bad Gateway**

**Cause**: Flask app not responding
**Solution**: Check web container status and logs

### **Issue: 503 Service Unavailable**

**Cause**: Rate limiting or upstream issues
**Solution**: Check rate limiting configuration and upstream health

### **Issue: SSL Handshake Failed**

**Cause**: Certificate issues or protocol mismatch
**Solution**: Verify SSL configuration and certificate validity

### **Issue: Permission Denied**

**Cause**: File permission issues
**Solution**: Check file ownership and permissions in containers

## üéØ **Next Steps**

1. **Deploy the optimized configuration**
2. **Run the troubleshooting script**
3. **Monitor logs for any remaining issues**
4. **Test all endpoints thoroughly**
5. **Set up monitoring and alerting**

## üìû **Support**

If you continue to experience issues:

1. Run the troubleshooting script
2. Check container logs
3. Verify network connectivity
4. Review this guide for common solutions

---

**Remember**: The key to resolving 403 errors is ensuring proper configuration alignment between Nginx, Flask, and Docker services.
